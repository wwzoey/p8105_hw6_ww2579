p8105\_hw6\_ww2579
================
Wenzhao Wu
11/24/2020

# Problem 1

``` r
homicide_df = 
  read_csv("data/homicide_data.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1)
  ) %>% 
  filter(
    victim_race %in% c("White", "Black"),
    city_state != "Tulsa, AL") %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```

    ## Parsed with column specification:
    ## cols(
    ##   uid = col_character(),
    ##   reported_date = col_double(),
    ##   victim_last = col_character(),
    ##   victim_first = col_character(),
    ##   victim_race = col_character(),
    ##   victim_age = col_double(),
    ##   victim_sex = col_character(),
    ##   city = col_character(),
    ##   state = col_character(),
    ##   lat = col_double(),
    ##   lon = col_double(),
    ##   disposition = col_character()
    ## )

Start with one city.

``` r
baltimore_df = 
  homicide_df %>%
  filter(city_state == "Baltimore, MD")

glm(resolution ~ victim_age + victim_sex + victim_race, data = baltimore_df,family = binomial()) %>%
  broom::tidy() %>%
  mutate(
    OR = exp(estimate),
    CL_lower = exp(estimate - 1.96 * std.error),
    CL_upper = exp(estimate + 1.96 * std.error)) %>%
  select(term, OR, starts_with(("CI"))) %>%
  knitr::kable(digits = 3)
```

| term              |    OR |
| :---------------- | ----: |
| (Intercept)       | 1.363 |
| victim\_age       | 0.993 |
| victim\_sexMale   | 0.426 |
| victim\_raceWhite | 2.320 |

Try this across cities.

``` r
models_results_df = 
  homicide_df %>%
  nest(data = -city_state) %>%
  mutate(
    models = 
      map(.x = data, ~glm(resolution ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)) %>%
  select(city_state, results) %>%
  unnest(results) %>%
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)) %>%
  select(city_state, term, OR, starts_with(("CI")))
```

Make a plot of city\_state vs OR.

``` r
models_results_df %>%
  filter(term == "victim_sexMale") %>%
  mutate(city_state = fct_reorder(city_state, OR)) %>%
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) +
  theme(axis.title.x = element_text(angle = 90, hjust = 1))
```

<img src="p8105_hw6_ww2579_files/figure-gfm/unnamed-chunk-4-1.png" width="90%" />

# Problem 2

Import and tidy the raw data.

``` r
bwt_df = read.csv("./data/birthweight.csv") %>%
  mutate(babysex = as.factor(babysex),
         frace = as.factor(frace),
         malform = as.factor(malform),
         mrace = as.factor(mrace),
         parity = as.factor(parity)) %>%
  mutate(babysex = recode(babysex, "1" = "male", "2" = "female"),
         mrace = recode(mrace, "1" = "White", "2" = "Black", "3" = "Asian", "4" = "Puerto Rican", "8" = "Other"))
```

Fit a regression model for birthweight.

``` r
# Full model
fit_bwt = lm(bwt~babysex + bhead + blength + delwt + fincome + frace + gaweeks + malform + menarche + mheight + momage + mrace + parity + pnumlbw + pnumsga + ppbmi + ppwt + smoken + wtgain, data = bwt_df)
summary(fit_bwt) 
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ babysex + bhead + blength + delwt + fincome + 
    ##     frace + gaweeks + malform + menarche + mheight + momage + 
    ##     mrace + parity + pnumlbw + pnumsga + ppbmi + ppwt + smoken + 
    ##     wtgain, data = bwt_df)
    ## 
    ## Residuals:
    ##     Min      1Q  Median      3Q     Max 
    ## -1098.1  -184.9    -3.1   172.7  2345.2 
    ## 
    ## Coefficients: (3 not defined because of singularities)
    ##                     Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)       -6264.8032   660.6094  -9.483  < 2e-16 ***
    ## babysexfemale        28.6471     8.4673   3.383 0.000723 ***
    ## bhead               130.7262     3.4535  37.853  < 2e-16 ***
    ## blength              74.9913     2.0225  37.079  < 2e-16 ***
    ## delwt                 4.1031     0.3949  10.390  < 2e-16 ***
    ## fincome               0.2916     0.1796   1.623 0.104561    
    ## frace2               14.2737    46.1574   0.309 0.757153    
    ## frace3               21.2028    69.3068   0.306 0.759675    
    ## frace4              -47.0217    44.6852  -1.052 0.292726    
    ## frace8                4.3377    74.0856   0.059 0.953313    
    ## gaweeks              11.5347     1.4670   7.863 4.72e-15 ***
    ## malform1              9.7650    70.6367   0.138 0.890055    
    ## menarche             -3.6007     2.8962  -1.243 0.213840    
    ## mheight               9.7891    10.3140   0.949 0.342621    
    ## momage                0.7668     1.2232   0.627 0.530734    
    ## mraceBlack         -151.5083    46.0525  -3.290 0.001010 ** 
    ## mraceAsian          -91.3613    71.9300  -1.270 0.204103    
    ## mracePuerto Rican   -56.4685    45.1438  -1.251 0.211054    
    ## parity1             302.9505   272.9067   1.110 0.267023    
    ## parity3             201.2521   273.3497   0.736 0.461622    
    ## parity6             581.4134   274.3701   2.119 0.034140 *  
    ## pnumlbw                   NA         NA      NA       NA    
    ## pnumsga                   NA         NA      NA       NA    
    ## ppbmi                 4.3740    14.8953   0.294 0.769041    
    ## ppwt                 -3.4761     2.6128  -1.330 0.183447    
    ## smoken               -4.8587     0.5872  -8.274  < 2e-16 ***
    ## wtgain                    NA         NA      NA       NA    
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 272.5 on 4318 degrees of freedom
    ## Multiple R-squared:  0.7184, Adjusted R-squared:  0.7169 
    ## F-statistic: 478.9 on 23 and 4318 DF,  p-value: < 2.2e-16

``` r
# 10 predictors model
multi10_fit = lm(bwt~babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + ppwt + smoken, data = bwt_df)
summary(multi10_fit)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ babysex + bhead + blength + delwt + fincome + 
    ##     gaweeks + mheight + mrace + ppwt + smoken, data = bwt_df)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -1095.75  -185.20    -3.49   174.29  2350.88 
    ## 
    ## Coefficients:
    ##                     Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)       -6087.5526   137.5399 -44.260  < 2e-16 ***
    ## babysexfemale        29.1153     8.4563   3.443 0.000581 ***
    ## bhead               130.9376     3.4478  37.977  < 2e-16 ***
    ## blength              74.8772     2.0199  37.069  < 2e-16 ***
    ## delwt                 4.1277     0.3922  10.525  < 2e-16 ***
    ## fincome               0.3095     0.1748   1.771 0.076681 .  
    ## gaweeks              11.3208     1.4584   7.762 1.03e-14 ***
    ## mheight               6.5568     1.7858   3.672 0.000244 ***
    ## mraceBlack         -139.0908     9.9117 -14.033  < 2e-16 ***
    ## mraceAsian          -75.1628    42.3374  -1.775 0.075914 .  
    ## mracePuerto Rican  -101.3783    19.3330  -5.244 1.65e-07 ***
    ## ppwt                 -2.6971     0.4275  -6.309 3.09e-10 ***
    ## smoken               -4.8487     0.5859  -8.276  < 2e-16 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 272.5 on 4329 degrees of freedom
    ## Multiple R-squared:  0.7177, Adjusted R-squared:  0.7169 
    ## F-statistic: 917.3 on 12 and 4329 DF,  p-value: < 2.2e-16

``` r
# 6-predictor model
multi6_fit = lm(bwt~babysex + bhead + blength + delwt + gaweeks + mrace, data = bwt_df)
summary(multi6_fit)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ babysex + bhead + blength + delwt + gaweeks + 
    ##     mrace, data = bwt_df)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -1110.84  -182.95    -5.61   178.31  2407.38 
    ## 
    ## Coefficients:
    ##                     Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)       -5937.1631    98.3708 -60.355  < 2e-16 ***
    ## babysexfemale        32.4648     8.5499   3.797 0.000148 ***
    ## bhead               133.7340     3.4797  38.433  < 2e-16 ***
    ## blength              77.1428     2.0300  38.001  < 2e-16 ***
    ## delwt                 2.1446     0.1971  10.883  < 2e-16 ***
    ## gaweeks              11.3502     1.4713   7.714 1.50e-14 ***
    ## mraceBlack         -126.6847     8.9695 -14.124  < 2e-16 ***
    ## mraceAsian          -48.5925    42.7216  -1.137 0.255425    
    ## mracePuerto Rican  -105.4304    18.8258  -5.600 2.27e-08 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 276 on 4333 degrees of freedom
    ## Multiple R-squared:  0.7101, Adjusted R-squared:  0.7096 
    ## F-statistic:  1327 on 8 and 4333 DF,  p-value: < 2.2e-16

``` r
# 4-predictor model
multi4_fit = lm(bwt~babysex + bhead + blength + wtgain, data = bwt_df)
summary(multi4_fit)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ babysex + bhead + blength + wtgain, data = bwt_df)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -1153.45  -193.81    -9.23   178.94  2679.16 
    ## 
    ## Coefficients:
    ##                 Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)   -6022.1555    97.3122 -61.885  < 2e-16 ***
    ## babysexfemale    41.1410     8.8030   4.674 3.05e-06 ***
    ## bhead           145.5590     3.4903  41.704  < 2e-16 ***
    ## blength          83.1383     2.0618  40.322  < 2e-16 ***
    ## wtgain            3.7220     0.4051   9.187  < 2e-16 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 285.8 on 4337 degrees of freedom
    ## Multiple R-squared:  0.689,  Adjusted R-squared:  0.6887 
    ## F-statistic:  2402 on 4 and 4337 DF,  p-value: < 2.2e-16

``` r
# Criterion-based procedures
AIC(fit_bwt)
```

    ## [1] 61045.21

``` r
AIC(multi10_fit)
```

    ## [1] 61033.15

``` r
AIC(multi6_fit)
```

    ## [1] 61140.29

``` r
AIC(multi4_fit)
```

    ## [1] 61438.47

First, I fitted all variables in a MLR model, and select variables of
interest to build different models. Based on the summary of regression
models, I compare the adjusted r^2 to check the goodness of fit. Among
the 4 models above, the model with 10 predictors has the largest value
of the adjusted r^2. Then I applied the criterion-based procedures to
check for AIC to obtain a relatively “good” model. As a result, the
10-predictor model has the smallest AIC value.

Selected predictors: babysex, bhead, blength, delwt, fincome, gaweeks,
mheight, mrace, ppwt, smoken.

Plot model residuals vs fitted values.

``` r
new_df = bwt_df %>%
  add_predictions(multi10_fit) %>%
  add_residuals(multi10_fit)

resid_pred_plt = 
  new_df %>%
  ggplot(aes(x = pred, y = resid,color = babysex)) +
  geom_point() +
  geom_smooth(method = "lm", se = F)

resid_pred_plt
```

    ## `geom_smooth()` using formula 'y ~ x'

<img src="p8105_hw6_ww2579_files/figure-gfm/unnamed-chunk-7-1.png" width="90%" />

**Interpretation:**

As it is shown on the graph, most of the residuals bounce around 0, but
the variance seems not quite constant and outliers are observed on the
upper left.

The second fitted model:

``` r
fit2 = lm(bwt~blength + gaweeks, data = bwt_df)
summary(fit2)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ blength + gaweeks, data = bwt_df)
    ## 
    ## Residuals:
    ##     Min      1Q  Median      3Q     Max 
    ## -1709.6  -215.4   -11.4   208.2  4188.8 
    ## 
    ## Coefficients:
    ##              Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept) -4347.667     97.958  -44.38   <2e-16 ***
    ## blength       128.556      1.990   64.60   <2e-16 ***
    ## gaweeks        27.047      1.718   15.74   <2e-16 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 333.2 on 4339 degrees of freedom
    ## Multiple R-squared:  0.5769, Adjusted R-squared:  0.5767 
    ## F-statistic:  2958 on 2 and 4339 DF,  p-value: < 2.2e-16

The third fitted model:

``` r
fit3 = lm(bwt~babysex*bhead*blength, data = bwt_df)
summary(fit3)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ babysex * bhead * blength, data = bwt_df)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -1132.99  -190.42   -10.33   178.63  2617.96 
    ## 
    ## Coefficients:
    ##                               Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)                 -7176.8170  1264.8397  -5.674 1.49e-08 ***
    ## babysexfemale                6374.8684  1677.7669   3.800 0.000147 ***
    ## bhead                         181.7956    38.0542   4.777 1.84e-06 ***
    ## blength                       102.1269    26.2118   3.896 9.92e-05 ***
    ## babysexfemale:bhead          -198.3932    51.0917  -3.883 0.000105 ***
    ## babysexfemale:blength        -123.7729    35.1185  -3.524 0.000429 ***
    ## bhead:blength                  -0.5536     0.7802  -0.710 0.478012    
    ## babysexfemale:bhead:blength     3.8781     1.0566   3.670 0.000245 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 287.7 on 4334 degrees of freedom
    ## Multiple R-squared:  0.6849, Adjusted R-squared:  0.6844 
    ## F-statistic:  1346 on 7 and 4334 DF,  p-value: < 2.2e-16

**Comments:**

Based on regression analysis of two models, the model with a 3-way
interaction seems fit better than the two-predictor model. The larger
r^2 value implies a better “goodness of fit”. From the results of fit3,
the 3-way interaction of sex, head circumference and length at birth is
statistically significant; while there seems no interaction effect
between the head circumference and baby’s length at birth.

Compare 3 models above using cross validation.

``` r
cv_df = crossv_mc(bwt_df,100)
cv_df =
  cv_df %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

    
cv_df = 
  cv_df %>% 
  mutate(  
    fit1 = map(train, ~lm(data = .x, bwt~babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + ppwt + smoken)), 
    fit2 = map(train, ~lm(bwt~blength + gaweeks, data = .x)),
    fit3 = map(train, ~lm(bwt~babysex*bhead*blength, data = .x))) %>% 
  mutate(rmse_fit1 = map2(fit1, test, ~rmse(model = .x, data = .y)), 
         rmse_fit2 = map2(fit2, test, ~rmse(model = .x, data = .y)),
         rmse_fit3 = map2(fit3, test, ~rmse(model = .x, data = .y)))

cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>%
  unnest(rmse) %>%
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin() +
  labs(
    title = "Prediction Error Distributions")
```

<img src="p8105_hw6_ww2579_files/figure-gfm/unnamed-chunk-10-1.png" width="90%" />

**Comments:**

Fit1 is the model that I built by variable selection. Fit2 uses length
at birth and gestational age as predictors. Fit3 is the one contains
3-way interaction term. The graph of “Prediction Error Distributions” is
used to compared predictive performance of different models. RMSE is
computed for measurements. Based on what is shown on the graph, the
first fitted model (i.e. 10-predictor model) has the lowest value of
RMSE, thus has the best predictive performance among the three models.
The second one, however, has the least predictive accuracy.

# Problem 3

Import and tidy and weather\_df.

``` r
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

    ## Registered S3 method overwritten by 'hoardr':
    ##   method           from
    ##   print.cache_info httr

    ## using cached file: C:\Users\WUWENZHAO\AppData\Local\cache/R/noaa_ghcnd/USW00094728.dly

    ## date created (size, mb): 2020-09-12 17:07:45 (7.533)

    ## file min/max dates: 1869-01-01 / 2020-09-30
